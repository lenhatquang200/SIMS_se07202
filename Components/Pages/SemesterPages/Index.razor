@page "/semesters"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using SIMS.Data
@implements IAsyncDisposable
@inject IDbContextFactory<SIMS.Data.ApplicationDbContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>Semesters</PageTitle>

<div class="container-fluid px-4">
    <div class="row my-4">
        <div class="col">
     <h2 class="fw-bold text-primary"><i class="bi bi-calendar3"></i> Semesters</h2>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
     <div class="input-group">
  <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" placeholder="Search semesters..." 
      @bind="searchTerm" @bind:event="oninput" @onkeyup="FilterSemesters" />
            </div>
        </div>
    <div class="col-md-6 text-md-end">
            <a href="semesters/create" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i> Create New Semester
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
     <QuickGrid Class="table table-hover mb-0" Items="@filteredSemesters">
        <PropertyColumn Property="semester => semester.Name" Title="Semester Name" />
      
    <TemplateColumn Title="Actions" Align="Align.Center">
           <div class="d-flex justify-content-center gap-2">
             <a href="@($"semesters/edit?id={context.Id}")" class="btn btn-primary btn-sm">
           <i class="bi bi-pencil-square me-1"></i> Edit
               </a>
       <a href="@($"semesters/details?id={context.Id}")" class="btn btn-info btn-sm text-white">
     <i class="bi bi-info-circle me-1"></i> Details
        </a>
          <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(context)">
      <i class="bi bi-trash me-1"></i> Delete
   </button>
         </div>
                </TemplateColumn>
     </QuickGrid>
     </div>
    </div>

    @if (showDeleteDialog)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog">
       <div class="modal-content">
          <div class="modal-header">
    <h5 class="modal-title">Confirm Delete</h5>
       <button type="button" class="btn-close" @onclick="CancelDelete"></button>
    </div>
           <div class="modal-body">
  Are you sure you want to delete semester "@selectedSemester?.Name"?
  </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
        <button type="button" class="btn btn-danger" @onclick="DeleteSemester">Delete</button>
      </div>
       </div>
     </div>
       <div class="modal-backdrop fade show"></div>
        </div>
    }
</div>

@code {
    private ApplicationDbContext context = default!;
    private IQueryable<Semester> filteredSemesters = null!;
    private string searchTerm = "";
    private bool showDeleteDialog = false;
    private Semester? selectedSemester;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
        filteredSemesters = context.Semesters;
    }

    private void FilterSemesters()
    {
      if (string.IsNullOrWhiteSpace(searchTerm))
        {
   filteredSemesters = context.Semesters;
        }
    else
        {
   filteredSemesters = context.Semesters
          .Where(s => s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
    }

 private void ConfirmDelete(Semester semester)
    {
        selectedSemester = semester;
        showDeleteDialog = true;
    }

    private void CancelDelete()
    {
        selectedSemester = null;
        showDeleteDialog = false;
    }

    private async Task DeleteSemester()
    {
 if (selectedSemester != null)
   {
         context.Semesters.Remove(selectedSemester);
 await context.SaveChangesAsync();
            showDeleteDialog = false;
          selectedSemester = null;
            FilterSemesters(); // Refresh the list
   }
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
